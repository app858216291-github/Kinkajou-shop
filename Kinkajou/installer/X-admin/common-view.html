<!DOCTYPE html>
<html class="x-admin-sm">
    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-X-admin2.2</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="./css/font.css">
        <link rel="stylesheet" href="./css/xadmin.css">
        <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="./js/xadmin.js"></script>
		<script type="text/javascript" src="./js/common.js"></script>
		<script type="text/javascript" src="./js/jquery.min.js"></script>
		
        <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
        <!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]--></head>
		<style>
		.layui-upload-img{width: 92px; height: 92px; margin: 0 10px 10px 0;}
		.layui-upload{margin-left: 70px;}
		.layui-upload_detail{margin-left: 70px;}
		</style>
<script>
function getQueryVariable(variable)
	{
		   var query = window.location.search.substring(1);
		   var vars = query.split("&");
		   for (var i=0;i<vars.length;i++) {
				   var pair = vars[i].split("=");
				   if(pair[0] == variable){return pair[1];}
		   }
		   return(false);
	};
</script>
    <body>
        <div class="layui-fluid">
            <div class="layui-row">
                <form class="layui-form" action="" id="form" lay-filter="example">
                </form>
            </div>
        </div>

        <script>
			let table=getQueryVariable("table")
			
			pyshop=sessionStorage.getItem(table);
			pyshop=JSON.parse(pyshop);
			cols=pyshop.list.colsArr[0]
			
			for(var i=0;i<cols.length;i++){
				col=cols[i]
				if(!col.field){
					continue
				}
				if(col.show==false){
					continue
				}
				
				
				  
				
				if(col.pType=='image'){
					
					$("#form").append(
					'<div class="layui-form-item">'
						+'<div class="layui-upload_detail">'
							+'<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">'
								+'预览图：'
								+'<div class="layui-upload-list" id="'+col.field+'_show"  style="height: 124px;"></div>'
							+'</blockquote>'		
						+'</div>'
					+'</div>'
					);
					continue
				}
				
				$("#form").append(
				'<div class="layui-form-item">'
				            +'<label for="L_email" class="layui-form-label">'
				                +'<span class="x-red">*</span>'+col.title+'</label>'
				            +'<div class="layui-input-inline">'
				           +'<input type="text" readonly="readonly" id="L_email" name="'+col.field+'" required="" lay-verify="title" autocomplete="off" class="layui-input"></div>'
				 +'</div>'
				);	
			}
						
			
			layui.use(['form', 'layer'],
            function() {
				 //表单初始赋值
				
                $ = layui.jquery;
				$.ajaxSettings.async = false;
                var form = layui.form,
                layer = layui.layer;

				let product = {}
				
				aa=prop().serviceUrl+"common/model/queryById/?modelName="+table+"&id=" + getQueryVariable("id");
				$.get(prop().serviceUrl+"/common/model/queryById/?modelName="+table+"&id=" + getQueryVariable("id"), function(data, status) {
					
					product = data
					product = JSON.parse(product);
					// uploadInst.upload();
				});
				for(var p in product.data){
					if('img' in pyshop){
						for(var i=0;i<pyshop.img.length;i++){
							if(p==pyshop.img[i]){
								images=product.data[p];
								images=images.split(',');
								for(var j=0;j<images.length;j++){
									if(images[j]!==""){
										a='#'+p+'_show';
										b=images[j];
										$('#'+p+'_show').append('<div class="imgBox" style="float: left;"><img src="'+ images[j] +'" class="layui-upload-img"></div>')
									}
								}
							}
						}
					}
					
				}
				form.val('example', product.data)
				
                //监听提交
                form.on('submit(add)',
                function(data) {
                    console.log(data);
					data=data.field
                    $.get(prop().serviceUrl+"/common/model/edit?modelName="+table+"&id=" + getQueryVariable("id"),data,function(data,status){
	
                    	data
                    	data= JSON.parse(data);
						data=product.data
						
                    });
                    layer.alert("修改成功", {
                        icon: 6
                    },
                    function() {
                        // 获得frame索引
                        var index = parent.layer.getFrameIndex(window.name);
                        //关闭当前frame
                        parent.layer.close(index);
                    });
                    return false;
                });

            });
			
			</script>
    </body>

</html>
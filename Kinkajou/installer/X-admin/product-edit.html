<!DOCTYPE html>
<html class="x-admin-sm">
	<head>
		<meta charset="UTF-8">
		<title>欢迎页面-X-admin2.2</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
		<link rel="stylesheet" href="./css/font.css">
		<link rel="stylesheet" href="./css/xadmin.css">
		<script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
		<script type="text/javascript" src="./js/xadmin.js"></script>
		<script type="text/javascript" src="./js/common.js"></script>
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
		<!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
	</head>
	<style>
		.layui-upload-img{width: 92px; height: 92px; margin: 0 10px 10px 0;}
		.layui-upload{margin-left: 70px;}
		.layui-upload_detail{margin-left: 70px;}
	</style>
	<script>
		function getQueryVariable(variable)
	{
		   var query = window.location.search.substring(1);
		   var vars = query.split("&");
		   for (var i=0;i<vars.length;i++) {
				   var pair = vars[i].split("=");
				   if(pair[0] == variable){return pair[1];}
		   }
		   return(false);
	};
</script>
	<body>
		<div class="layui-fluid">
			<div class="layui-row">
				<form class="layui-form" action="" lay-filter="example">
					<input type="hidden" id="main_image" name="main_image" value="" />
					<input type="hidden" id="detail_image" name="detail_image" value="" />
					<div class="layui-form-item">
						<label for="L_email" class="layui-form-label">
							<span class="x-red">*</span>标题</label>
						<div class="layui-input-inline">
							<input type="text" id="L_email" name="title" required="" lay-verify="title" autocomplete="off" class="layui-input"></div>
					</div>

					<div class="layui-form-item">
						<div class="layui-upload">
							<button type="button" class="layui-btn" id="test1">上传主图</button>
							<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
								预览图：
								<div class="layui-upload-list" id="demo1" style="height: 124px;"></div>
							</blockquote>
							<!-- <div class="layui-upload-list">
					     		<img class="layui-upload-img" id="demo1">
					     		<p id="demoText"></p>
					     	  </div> -->
						</div>
					</div>


					<div class="layui-form-item">
						<label for="L_username" class="layui-form-label">
							<span class="x-red">*</span>价格</label>
						<div class="layui-input-inline">
							<input type="text" id="L_username" name="price" required="" lay-verify="price" autocomplete="off" class="layui-input"></div>
					</div>
					<div class="layui-form-item">
						<label for="L_pass" class="layui-form-label">
							<span class="x-red">*</span>库存</label>
						<div class="layui-input-inline">
							<input type="text" id="L_pass" name="store" required="" lay-verify="store" autocomplete="off" class="layui-input"></div>
					</div>
					<div class="layui-form-item">
						<label for="L_username" class="layui-form-label">
							<span class="x-red">*</span>颜色</label>
						<div class="layui-input-inline">
							<input type="text" id="L_username" name="color" required="" lay-verify="color" autocomplete="off" class="layui-input"></div>
					</div>
					<div class="layui-form-item">
						<label for="L_repass" class="layui-form-label">
							<span class="x-red">*</span>尺码</label>
						<div class="layui-input-inline">
							<input type="text" id="L_repass" name="size" required="" lay-verify="size" autocomplete="off" class="layui-input"></div>
					</div>
					<div class="layui-form-item">
						<div class="layui-upload_detail">
							<button type="button" class="layui-btn" id="upload_detail">上传详情页图</button>
							<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
								预览图：
								<div class="layui-upload-list" id="upload_detail_show"  style="height: 124px;"></div>
							</blockquote>

						</div>
					</div>

					<div class="layui-form-item">
						<label for="L_repass" class="layui-form-label"></label>
						<button class="layui-btn" lay-filter="add" lay-submit="" id="test9">修改<i id="upload"></i></button>
						<button style="display: none;" class="layui-btn" lay-filter="add" lay-submit="" id="hiddenBottono">修改2</button>
					</div>
				</form>
			</div>
		</div>
		<script>
			layui.use('upload', function() {
				var $ = layui.jquery,
					uploadloadDetail = layui.upload;
				//普通图片上传
				// document.getElementById("detail_image").value = "";
				//详情页主图上传
				let uploadInstDetail = uploadloadDetail.render({
					elem: '#upload_detail',
					url: prop().serviceUrl+'/common/upload/?dir=product',
					multiple: true,
					auto: false
						//,multiple: true
						,
					bindAction: '#hiddenBottono',
					choose: function(obj) {
						//预读本地文件示例，不支持ie8
						obj.preview(function(index, file, result) {
							var files = obj.pushFile()
							// $('#upload_detail_show').append('<img src="' + result + '" alt="' + file.name +
							// 	'" class="layui-upload-img">');
							$('#upload_detail_show').append('<div class="imgBox" style="float: left;"><em class="remove_'+index+'">删除</em><br><img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img"></div>')
							$('.remove_'+index).bind('click',function(){
								delete files[index];//删除指定图片
								$(this).parent().remove();
							})

						});
					},
					done: function(res) {
						//如果上传失败
						if (res.code > 0) {
							return layer.msg('上传失败');
						}
						//上传成功
						document.getElementById("detail_image").value = document.getElementById("detail_image").value + "," + res.data;
					}

				});
				$("#test9").on('click', function() {
					uploadInstDetail.upload();
				});

			});
		</script>
		<script>
			layui.use('upload', function() {
				var $ = layui.jquery,
					upload = layui.upload;
				//普通图片上传
				// document.getElementById("main_image").value = "";
				// document.getElementById("detail_image").value="";
				let uploadInst = upload.render({
					elem: '#test1',
					url: prop().serviceUrl+'/common/upload/?dir=product',
					multiple: true,
					auto: false
						//,multiple: true
						,
					bindAction: '#hiddenBottono',
					before: function(obj) {
						//预读本地文件示例，不支持ie8
						obj.preview(function(index, file, result) {
						
							//预读本地文件示例，不支持ie8
							// $('#demo1').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')  //多文件上传
							// $('#demo1').attr('src', result); //图片链接（base64）//单文件上传
						});
					},
					choose: function(obj) {
						
						var files = obj.pushFile()
						//预读本地文件示例，不支持ie8
						obj.preview(function(index, file, result) {
							
							// $('#demo1').append('<img src="' + result + '" alt="' + file.name + '" class="layui-upload-img">')
							
							$('#demo1').append('<div class="imgBox" style="float: left;"><em class="remove_'+index+'">删除</em><br><img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img"></div>')
							$('.remove_'+index).bind('click',function(){
								delete files[index];//删除指定图片
								$(this).parent().remove();

							})
					
							
						});
					},
					done: function(res) {
						//如果上传失败
						if (res.code > 0) {
							return layer.msg('上传失败');
						}
						//上传成功
					
						aa = document.getElementById("main_image").value;
						document.getElementById("main_image").value = document.getElementById("main_image").value + "," + res.data;
						console.info(document.getElementById("main_image").value)
					},
					error: function() {
						
						//演示失败状态，并实现重传
						var demoText = $('#demoText');
						demoText.html(
							'<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
						demoText.find('.demo-reload').on('click', function() {
							// uploadInst.upload();
						});
					}
				});
				$("#test9").on('click', function() {
					uploadInst.upload();
				});

			});
		</script>
		<script>
			layui.use(['form', 'layer'],
				function() {
					//表单初始赋值

					$ = layui.jquery;
					$.ajaxSettings.async = false;
					var form = layui.form,
						layer = layui.layer;
					let product = {}

					$.get(prop().serviceUrl+"/product/productDetail?id=" + getQueryVariable("id"), function(data, status) {
						product = data
						product = JSON.parse(product);
						debugger;
						//-----主图初始化 start---
						let mainImages={};
						mainImages.img=product.data.main_image;
						if(mainImages.img && mainImages.img.length>0){	
							images=mainImages.img.split(',');
							for(var j=0;j<images.length;j++){
								if(images[j]!==""){
									$('#demo1').append('<div class="imgBox" style="float: left;"><em class="remove_demo" imgsrc="'+ images[j] +'">删除</em><br><img src="'+ images[j] +'" class="layui-upload-img"></div>')
								}
							}
							$('.remove_demo').bind('click',function(){
								// delete files[index];//删除指定图片
								let cc=$(this).parent().children("img").attr('src');
								let kk=$("#main_image").val();
								// kk=string.replace("a","b");
								kk=kk.replace(cc,"");
								kk=kk.replace(",,",",");
								$("#main_image").val(kk);
								debugger
								$(this).parent().remove();
							})
						}
						
						//--------- 主图初始化 end---------
						
						//----- 详情图初始化start---
						let mainDetail={};
						mainDetail.img=product.data.detail_image;
						if(mainDetail.img && mainDetail.img.length>0){	
							images=mainDetail.img.split(',');
							for(var j=0;j<images.length;j++){
								if(images[j]!==""){
									$('#upload_detail_show').append('<div class="imgBox" style="float: left;"><em class="remove_detail" imgsrc="'+ images[j] +'">删除</em><br><img src="'+ images[j] +'" class="layui-upload-img"></div>')
								}
							}
							$('.remove_detail').bind('click',function(){
								// delete files[index];//删除指定图片
								let cc=$(this).parent().children("img").attr('src');
								let kk=$("#detail_image").val();
								// kk=string.replace("a","b");
								kk=kk.replace(cc,"");
								kk=kk.replace(",,",",");
								$("#detail_image").val(kk);
								
								$(this).parent().remove();
							})
						}
						
						//---------详情图初始化 end---------
						
						// uploadInst.upload();
					});
					form.val('example', product.data)

					//自定义验证规则
					form.verify({
						title: function(value) {
							if (value.length < 3) {
								return '昵称至少得3个字符啊';
							}
						},
					});

					//监听提交
					form.on('submit(add)',
						function(data) {
							console.log(data);
							data = data.field
							debugger
							$.get(prop().serviceUrl+"/product/editproduct?id=" + getQueryVariable("id"), data, function(data, status) {
								
								product = data;
								product = JSON.parse(product);
							});
							layer.alert("增加成功", {
									icon: 6
								},
								function() {
									// 获得frame索引
									var index = parent.layer.getFrameIndex(window.name);
									//关闭当前frame
									parent.layer.close(index);
								});
							return false;
						});

				});
		</script>
		<script>
			var _hmt = _hmt || [];
			(function() {
				var hm = document.createElement("script");
				hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
				var s = document.getElementsByTagName("script")[0];
				s.parentNode.insertBefore(hm, s);
			})();
		</script>
	</body>

</html>
